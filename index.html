<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PvZ Horror Remake</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="1636" height="1332"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Configuraci칩n
        const CONFIG = {
            grid: {
                startX: 90,
                startY: 280,
                endX: 1577,
                endY: 1260,
                cols: 9,
                rows: 5
            },
            ui: {
                seedBarPos: { x: 10, y: 10 },
                sunRange: { start: 10, end: 200 },
                seedRange: { start: 200, end: 1110 },
                shovelRange: { start: 1110, end: 1237 },
                text: {
                    sunY: 195,
                    sunSize: 40,
                    seedCostY: 183,
                    seedCostSize: 25
                },
                positions: {
                    sunIconY: 0,
                    shovelY: 0,
                    seedPacketY: 20,
                    seedImageY: 0
                }
            },
            lawnmower: {
                x: -70
            }
        };

        // Estado del juego
        const state = {
            suns: 50,
            seeds: [
                { name: 'girasol', image: 'semilla de girasol', cost: 50 },
                { name: 'lanzaguisantes', image: 'semilla de lanza guisantes', cost: 100 },
                { name: 'nuez', image: 'semilla de nuez', cost: 50 },
                { name: 'cereza', image: 'semilla de cereza', cost: 150 }
            ]
        };

        // Recursos
        const resources = {
            images: {},
            toLoad: [
                { id: 'background', src: 'recursos/background.png' },
                { id: 'barra_semillas', src: 'recursos/barra de semillas.png' },
                { id: 'sol_ui', src: 'recursos/sol.png' },
                { id: 'pala', src: 'recursos/pala.png' },
                { id: 'envoltura', src: 'recursos/envoltura de semilla.png' },
                { id: 'semilla_girasol', src: 'recursos/semilla de girasol.png' },
                { id: 'semilla_lanza_guisantes', src: 'recursos/semilla de lanza guisantes.png' },
                { id: 'semilla_nuez', src: 'recursos/semilla de nuez.png' },
                { id: 'semilla_cereza', src: 'recursos/semilla de cereza.png' },
                { id: 'cortacesped', src: 'recursos/cortacesped.png' }
            ]
        };

        // Carga de recursos
        let loadedCount = 0;
        function loadResources() {
            resources.toLoad.forEach(res => {
                const img = new Image();
                img.src = res.src;
                img.onload = () => {
                    loadedCount++;
                    if (loadedCount === resources.toLoad.length) {
                        init();
                    }
                };
                resources.images[res.id] = img;
            });
        }

        // --- [INICIO TAREA 1.1] ---
        // Motor de Audio (AudioManager)
        class AudioManager {
            constructor() {
                this.sounds = {};
                this.soundList = [
                    'Los zombis se acercan inicio.mp3',
                    'choque guisante.mp3',
                    'cereza explota.mp3',
                    'zombi muere.mp3',
                    'plantar.mp3',
                    'recolectar sol.mp3',
                    'cortacesped.mp3',
                    'horda.mp3',
                    'musica fondo.mp3'
                ];
                this.preloadSounds();
            }

            preloadSounds() {
                this.soundList.forEach(soundName => {
                    const audio = new Audio();
                    // Usar encodeURIComponent para manejar nombres con espacios
                    const encodedName = encodeURIComponent(soundName);
                    audio.src = `recursos/sonidos/${encodedName}`;
                    audio.preload = 'auto';
                    // Guardar con el nombre original (sin espacios codificados) como clave
                    this.sounds[soundName] = audio;
                });
            }

            play(name, volume = 1.0) {
                if (!this.sounds[name]) {
                    console.warn(`Sonido no encontrado: ${name}`);
                    return;
                }
                
                // Usar cloneNode() para permitir reproducci칩n simult치nea
                const audioClone = this.sounds[name].cloneNode();
                audioClone.volume = Math.max(0, Math.min(1, volume)); // Clamp entre 0 y 1
                
                // Reproducir y limpiar cuando termine
                audioClone.play().catch(err => {
                    // Algunos navegadores bloquean autoplay, ignorar error
                    console.log('Audio bloqueado por el navegador:', err.message);
                });
                
                // Liberar memoria cuando termine
                audioClone.addEventListener('ended', () => {
                    audioClone.remove();
                });
            }
        }

        // Instancia global del AudioManager
        const audioManager = new AudioManager();

        // DUMMY TRIGGER PARA TESTING
        // Reproducir "Los zombis se acercan inicio.mp3" en el primer clic
        let firstClick = true;
        window.addEventListener('click', () => {
            if (firstClick) {
                firstClick = false;
                audioManager.play('Los zombis se acercan inicio.mp3', 0.7);
                console.log('游꿧 Audio de prueba reproducido: Los zombis se acercan inicio.mp3');
            }
        });
        // --- [FIN TAREA 1.1] ---

        function init() {
            console.log("Recursos cargados. Iniciando...");
            loop();
        }

        function loop() {
            render();
            requestAnimationFrame(loop);
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Background
            ctx.drawImage(resources.images.background, 0, 0);

            // 2. Grid (Lineas rojas)
            drawGrid();

            // 3. Cortacesped
            drawLawnmowers();

            // 4. Barra de semillas y UI
            drawUI();
        }

        function drawGrid() {
            ctx.save();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;

            const g = CONFIG.grid;
            const width = g.endX - g.startX;
            const height = g.endY - g.startY;
            const cellW = width / g.cols;
            const cellH = height / g.rows;

            // Dibujar rect치ngulo exterior
            // ctx.strokeRect(g.startX, g.startY, width, height);

            // Lineas verticales
            for (let i = 0; i <= g.cols; i++) {
                const x = g.startX + i * cellW;
                ctx.beginPath();
                ctx.moveTo(x, g.startY);
                ctx.lineTo(x, g.endY);
                ctx.stroke();
            }

            // Lineas horizontales
            for (let i = 0; i <= g.rows; i++) {
                const y = g.startY + i * cellH;
                ctx.beginPath();
                ctx.moveTo(g.startX, y);
                ctx.lineTo(g.endX, y);
                ctx.stroke();
            }
            ctx.restore();
        }

        function drawLawnmowers() {
            const g = CONFIG.grid;
            const height = g.endY - g.startY;
            const cellH = height / g.rows;
            const img = resources.images.cortacesped;

            for (let i = 0; i < g.rows; i++) {
                // Centrar verticalmente en la fila
                const rowCenterY = g.startY + i * cellH + (cellH / 2);
                // Ajustar Y para que el centro de la imagen coincida con el centro de la fila?
                // El prompt dice: "Los hitbox estar치n en el centro de las animaciones."
                // Pero para dibujo est치tico, usualmente dibujamos top-left de la imagen.
                // Asumiremos que se dibuja centrado verticalmente.
                const y = rowCenterY - (img.height / 2); 
                
                ctx.drawImage(img, CONFIG.lawnmower.x, y);
            }
        }

        function drawUI() {
            const ui = CONFIG.ui;
            
            // Barra de semillas (fondo)
            ctx.drawImage(resources.images.barra_semillas, ui.seedBarPos.x, ui.seedBarPos.y);

            // Sol UI
            const sunCenter = (ui.sunRange.start + ui.sunRange.end) / 2;
            const sunImg = resources.images.sol_ui;
            // "Las imagenes de 'sol' y 'pala' de la barra de semillas tendr치n una posici칩n en 'y' de 0."
            ctx.drawImage(sunImg, sunCenter - (sunImg.width / 2), ui.positions.sunIconY);

            // Texto Soles
            ctx.fillStyle = 'black'; // Asumo negro o visible
            ctx.font = `${ui.text.sunSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(state.suns, sunCenter, ui.text.sunY);

            // Semillas
            let currentX = ui.seedRange.start;
            const envImg = resources.images.envoltura;
            
            state.seeds.forEach(seed => {
                // Envoltura
                // "Las semillas que estaran apiladas a la izquierda de su rango."
                // "Ancho de la entidad semilla ser치 el ancho de la envoltura de semilla."
                
                // Dibujar envoltura
                ctx.drawImage(envImg, currentX, ui.positions.seedPacketY);
                
                // Dibujar imagen de la planta
                // "Las imagenes de semilla tendr치n una altura de 0."
                let plantImg;
                if(seed.name === 'girasol') plantImg = resources.images.semilla_girasol;
                else if(seed.name === 'lanzaguisantes') plantImg = resources.images.semilla_lanza_guisantes;
                else if(seed.name === 'nuez') plantImg = resources.images.semilla_nuez;
                else if(seed.name === 'cereza') plantImg = resources.images.semilla_cereza;

                if (plantImg) {
                    // Centrar horizontalmente en la envoltura
                    const centerX = currentX + (envImg.width / 2);
                    const drawX = centerX - (plantImg.width / 2);
                    ctx.drawImage(plantImg, drawX, ui.positions.seedImageY);
                }

                // Costo
                ctx.fillStyle = 'black';
                ctx.font = `${ui.text.seedCostSize}px Arial`;
                ctx.textAlign = 'center';
                // Centrado en la envoltura
                const centerX = currentX + (envImg.width / 2);
                ctx.fillText(seed.cost, centerX, ui.text.seedCostY);

                // Avanzar X
                currentX += envImg.width;
            });

            // Pala
            const shovelCenter = (ui.shovelRange.start + ui.shovelRange.end) / 2;
            const shovelImg = resources.images.pala;
            ctx.drawImage(shovelImg, shovelCenter - (shovelImg.width / 2), ui.positions.shovelY);
        }

        // Iniciar
        loadResources();

    </script>
</body>
</html>