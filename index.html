<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plants vs. Zombies - IA Agents</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        canvas {
            max-width: 100%;
            max-height: 100vh;
            display: block;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="1636" height="1332"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Configuración de la Grid
    const GRID_START_X = 90;
    const GRID_START_Y = 280;
    const GRID_END_X = 1577;
    const GRID_END_Y = 1260;
    const COLS = 9;
    const ROWS = 5;
    const CELL_WIDTH = (GRID_END_X - GRID_START_X) / COLS;
    const CELL_HEIGHT = (GRID_END_Y - GRID_START_Y) / ROWS;
    
    // Variables Globales del Motor
    let frames = 0;
    let isPaused = false;
    let isDebug = false;
    let mouseX = 0;
    let mouseY = 0;
    
    // Arrays de Entidades
    let suns = [];
    let plants = [];
    let zombies = [];
    let peas = [];
    let particles = [];
    let floatingTexts = [];
    const lawnmowers = [];
    
    // Sistema de Hordas
    const LEVEL_CONFIG = { totalZombies: 40, horde1Threshold: 20, horde2Threshold: 38, baseSpawnRate: 350 };
    let zombiesSpawned = 0;

    // Recursos
    const imageSources = {
        background: 'recursos/background.png',
        barraSemillas: 'recursos/barra de semillas.png',
        sol: 'recursos/sol.png', 
        pala: 'recursos/pala.png',
        envoltura: 'recursos/envoltura de semilla.png',
        semillaGirasol: 'recursos/semilla de girasol.png',
        semillaGuisante: 'recursos/semilla de lanza guisantes.png',
        semillaNuez: 'recursos/semilla de nuez.png',
        cortacesped: 'recursos/cortacesped.png'
    };

    // Frames de animación de plantas (se cargan dinámicamente)
    const plantAnimations = {
        girasol: { folder: 'girasol perturbador', prefix: 'girasol perturbador', frames: 58, images: [] },
        guisante: { folder: 'lg reposo perturbador', prefix: 'lg reposo perturbador', frames: 31, images: [] },
        nuez: { folder: 'nuez', prefix: 'nuez', frames: 1, images: [] }
    };

    const images = {};
    let imagesLoaded = 0;
    const totalImages = Object.keys(imageSources).length;

    // Datos de Semillas
    const seeds = [
        { name: 'girasol', imageKey: 'semillaGirasol', cost: 50, cooldown: 450, timer: 0 },
        { name: 'guisante', imageKey: 'semillaGuisante', cost: 100, cooldown: 450, timer: 0 },
        { name: 'nuez', imageKey: 'semillaNuez', cost: 50, cooldown: 1800, timer: 0 }
    ];

    // Estado del juego UI
    let sunAmount = 50; 
    const sunRange = { min: 10, max: 200 };
    const seedRange = { min: 200, max: 1110 };
    const shovelRange = { min: 1110, max: 1237 };
    
    let selectedSeed = null;
    let isShovelActive = false;
    let gridState = Array.from({ length: COLS }, () => Array(ROWS).fill(null));

    // ==========================================
    // 1. CLASES DE ENTIDADES (Agentes inyectan aquí)
    // ==========================================
    
    // --- [INICIO_ZONA_CLASE_SUN_1.1] ---
    // --- [FIN_ZONA_CLASE_SUN_1.1] ---

    // --- [INICIO_ZONA_CLASE_PEA_2.2] ---
    // --- [FIN_ZONA_CLASE_PEA_2.2] ---

    // --- [INICIO_ZONA_CLASE_ZOMBIE_2.1] ---
    // --- [FIN_ZONA_CLASE_ZOMBIE_2.1] ---

    // --- [INICIO_ZONA_CLASE_PLANT_1.3] ---
    class Plant {
        constructor(type, col, row) {
            this.type = type;
            this.col = col;
            this.row = row;
            this.x = GRID_START_X + (col * CELL_WIDTH) + (CELL_WIDTH / 2);
            this.y = GRID_START_Y + (row * CELL_HEIGHT) + (CELL_HEIGHT / 2);
            this.frame = 0;
            this.frameSpeed = 3; // Velocidad de animación
            this.flashTimer = 0;
            this.markedForDeletion = false;
            
            // HP según tipo de planta
            if (type === 'nuez') {
                this.hp = 4000;
            } else {
                this.hp = 300;
            }
        }

        takeDamage(amount) {
            this.hp -= amount;
            this.flashTimer = 4; // Parpadeo blanco durante 4 frames
            if (this.hp <= 0) {
                this.markedForDeletion = true;
                gridState[this.col][this.row] = null;
            }
        }

        update() {
            // Avanzar animación
            if (frames % this.frameSpeed === 0) {
                const anim = plantAnimations[this.type];
                if (anim) {
                    this.frame = (this.frame + 1) % anim.frames;
                }
            }
            // Reducir flashTimer
            if (this.flashTimer > 0) {
                this.flashTimer--;
            }
        }

        draw(ctx) {
            const anim = plantAnimations[this.type];
            if (!anim || !anim.images[this.frame]) return;

            const img = anim.images[this.frame];
            const drawX = this.x - (img.width / 2);
            const drawY = this.y - (img.height / 2) - 20; // Offset vertical para centrar mejor

            // Dibujar planta
            ctx.drawImage(img, drawX, drawY);

            // Efecto de flash blanco al recibir daño
            if (this.flashTimer > 0) {
                ctx.globalCompositeOperation = 'source-atop';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(drawX, drawY, img.width, img.height);
                ctx.globalCompositeOperation = 'source-over';
            }
        }
    }

    // Clase FloatingText para mostrar textos flotantes
    class FloatingText {
        constructor(text, x, y, color = '#FFD700') {
            this.text = text;
            this.x = x;
            this.y = y;
            this.color = color;
            this.alpha = 1;
            this.vy = -2; // Velocidad vertical (sube)
            this.markedForDeletion = false;
        }

        update() {
            this.y += this.vy;
            this.alpha -= 0.02;
            if (this.alpha <= 0) {
                this.markedForDeletion = true;
            }
        }

        draw(ctx) {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.font = 'bold 36px Arial';
            ctx.fillStyle = this.color;
            ctx.textAlign = 'center';
            ctx.fillText(this.text, this.x, this.y);
            ctx.restore();
        }
    }

    // Clase Particle para efectos de partículas
    class Particle {
        constructor(x, y, color, type = 'circle') {
            this.x = x;
            this.y = y;
            this.color = color;
            this.type = type;
            this.vx = (Math.random() - 0.5) * 8;
            this.vy = (Math.random() - 0.5) * 8 - 2;
            this.gravity = 0.2;
            this.alpha = 1;
            this.size = Math.random() * 6 + 3;
            this.markedForDeletion = false;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += this.gravity;
            this.alpha -= 0.03;
            if (this.alpha <= 0) {
                this.markedForDeletion = true;
            }
        }

        draw(ctx) {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.fillStyle = this.color;
            if (this.type === 'spark') {
                ctx.fillRect(this.x, this.y, this.size, this.size);
            } else {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }
    }

    // Función para crear partículas de tierra al plantar
    function spawnDirtParticles(x, y) {
        const colors = ['#8B4513', '#A0522D'];
        for (let i = 0; i < 12; i++) {
            const color = colors[Math.floor(Math.random() * colors.length)];
            particles.push(new Particle(x, y, color, 'circle'));
        }
    }
    // --- [FIN_ZONA_CLASE_PLANT_1.3] ---

    // ==========================================
    // 2. INPUTS Y EVENTOS
    // ==========================================
    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
        mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
    });

    canvas.addEventListener('mousedown', (e) => {
        if (isPaused) return;

        // --- [INICIO_ZONA_CLICK_SOLES_1.1] ---
        // --- [FIN_ZONA_CLICK_SOLES_1.1] ---

        // --- [INICIO_ZONA_CLICK_PALA_3.1] ---
        // --- [FIN_ZONA_CLICK_PALA_3.1] ---

        // --- [INICIO_ZONA_CLICK_PLANTAR_1.3] ---
        // Verificar si hay semilla seleccionada y estamos en el grid
        if (selectedSeed !== null) {
            const seed = seeds[selectedSeed];
            
            // Verificar si el clic está dentro del grid
            if (mouseX >= GRID_START_X && mouseX <= GRID_END_X &&
                mouseY >= GRID_START_Y && mouseY <= GRID_END_Y) {
                
                // Calcular columna y fila
                const col = Math.floor((mouseX - GRID_START_X) / CELL_WIDTH);
                const row = Math.floor((mouseY - GRID_START_Y) / CELL_HEIGHT);
                
                // Verificar que la celda esté vacía
                if (gridState[col][row] === null) {
                    // Verificar soles suficientes y cooldown
                    const canAfford = isDebug || sunAmount >= seed.cost;
                    const cooldownReady = isDebug || seed.timer <= 0;
                    
                    if (canAfford && cooldownReady) {
                        // Descontar costo
                        if (!isDebug) {
                            sunAmount -= seed.cost;
                            seed.timer = seed.cooldown;
                        }
                        
                        // Crear la planta
                        const newPlant = new Plant(seed.name, col, row);
                        plants.push(newPlant);
                        gridState[col][row] = newPlant;
                        
                        // Generar FloatingText rojo con el costo
                        floatingTexts.push(new FloatingText('-' + seed.cost, newPlant.x, newPlant.y - 50, '#FF0000'));
                        
                        // Reproducir sonido de plantar
                        new Audio('recursos/sonidos/Plantar.wav').play();
                        
                        // Generar partículas de tierra
                        spawnDirtParticles(newPlant.x, newPlant.y + 50);
                        
                        // Limpiar selección
                        selectedSeed = null;
                    }
                }
            }
        }
        // --- [FIN_ZONA_CLICK_PLANTAR_1.3] ---

        // --- [INICIO_ZONA_CLICK_SEMILLAS_1.2] ---
        // Detectar clic en la barra de semillas (Y entre 20 y 160)
        if (mouseY >= 20 && mouseY <= 160) {
            let currentSeedX = seedRange.min;
            const envolturaImg = images.envoltura;
            
            if (envolturaImg) {
                for (let i = 0; i < seeds.length; i++) {
                    const seedWidth = envolturaImg.width;
                    if (mouseX >= currentSeedX && mouseX <= currentSeedX + seedWidth) {
                        selectedSeed = i;
                        isShovelActive = false;
                        new Audio('recursos/sonidos/Clic carta.wav').play();
                        return;
                    }
                    currentSeedX += seedWidth;
                }
            }
        }
        // --- [FIN_ZONA_CLICK_SEMILLAS_1.2] ---
    });

    window.addEventListener('keydown', (e) => {
        // --- [INICIO_ZONA_TECLAS_DEBUG_3.2] ---
        // --- [FIN_ZONA_TECLAS_DEBUG_3.2] ---
    });

    // ==========================================
    // 3. INICIALIZACIÓN
    // ==========================================
    function init() {
        for (let i = 0; i < ROWS; i++) {
            lawnmowers.push({
                x: -70,
                y: GRID_START_Y + (i * CELL_HEIGHT) + (CELL_HEIGHT / 2) - 30,
                row: i,
                active: false
            });
        }
        
        loadImages();
    }

    function loadImages() {
        for (let key in imageSources) {
            const img = new Image();
            img.src = imageSources[key];
            img.onload = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    console.log('Todas las imágenes cargadas. Cargando animaciones...');
                    loadPlantAnimations();
                }
            };
            img.onerror = (e) => console.error('Error cargando imagen:', key, e);
            images[key] = img;
        }
    }

    function loadPlantAnimations() {
        let totalAnimFrames = 0;
        let loadedAnimFrames = 0;

        for (let plantType in plantAnimations) {
            totalAnimFrames += plantAnimations[plantType].frames;
        }

        for (let plantType in plantAnimations) {
            const anim = plantAnimations[plantType];
            for (let i = 0; i < anim.frames; i++) {
                const img = new Image();
                const frameNum = anim.frames === 1 ? i : i.toString().padStart(2, '0');
                img.src = `recursos/${anim.folder}/${anim.prefix}${frameNum}.png`;
                img.onload = () => {
                    loadedAnimFrames++;
                    if (loadedAnimFrames === totalAnimFrames) {
                        console.log('Animaciones de plantas cargadas. Iniciando juego.');
                        initGame();
                    }
                };
                img.onerror = (e) => console.error('Error cargando animación:', plantType, i, e);
                anim.images.push(img);
            }
        }
    }

    function initGame() {
        // === [TRIGGER_TAREA_1.1] ===
        // === [FIN_TRIGGER_TAREA_1.1] ===

        // === [TRIGGER_TAREA_1.3] ===
        sunAmount = 5000; // Soles ilimitados para pruebas
        // === [FIN_TRIGGER_TAREA_1.3] ===

        // === [TRIGGER_TAREA_2.1] ===
        // === [FIN_TRIGGER_TAREA_2.1] ===

        // === [TRIGGER_TAREA_2.2] ===
        // === [FIN_TRIGGER_TAREA_2.2] ===

        // === [TRIGGER_TAREA_3.2] ===
        // === [FIN_TRIGGER_TAREA_3.2] ===

        // === [TRIGGER_TAREA_4.1] ===
        // === [FIN_TRIGGER_TAREA_4.1] ===

        requestAnimationFrame(gameLoop);
    }

    // ==========================================
    // 4. LÓGICA PRINCIPAL (UPDATE)
    // ==========================================
    function checkCollisions() {
        // --- [INICIO_ZONA_COLISIONES_2.3] ---
        // --- [FIN_ZONA_COLISIONES_2.3] ---
    }

    function updateGame() {
        // --- [INICIO_ZONA_UPDATE_ENTIDADES] ---
        // Actualizar plantas
        plants.forEach(plant => plant.update());
        plants = plants.filter(p => !p.markedForDeletion);

        // Actualizar cooldowns de semillas
        seeds.forEach(seed => {
            if (seed.timer > 0) seed.timer--;
        });

        // Actualizar textos flotantes
        floatingTexts.forEach(ft => ft.update());
        floatingTexts = floatingTexts.filter(ft => !ft.markedForDeletion);

        // Actualizar partículas
        particles.forEach(p => p.update());
        particles = particles.filter(p => !p.markedForDeletion);
        // --- [FIN_ZONA_UPDATE_ENTIDADES] ---

        // === [TRIGGER_TAREA_3.3] ===
        // === [FIN_TRIGGER_TAREA_3.3] ===

        // --- [INICIO_ZONA_SPAWN_NORMAL_2.1] ---
        // --- [FIN_ZONA_SPAWN_NORMAL_2.1] ---

        // --- [INICIO_ZONA_SPAWN_HORDAS_4.2] ---
        // --- [FIN_ZONA_SPAWN_HORDAS_4.2] ---

        checkCollisions();
        frames++;
    }

    // ==========================================
    // 5. RENDERIZADO PRINCIPAL (DRAW)
    // ==========================================
    function gameLoop() {
        if (!isPaused) updateGame();
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (images.background) ctx.drawImage(images.background, 0, 0);

        drawGrid();

        // --- [INICIO_ZONA_DRAW_ENTIDADES] ---
        // Dibujar plantas
        plants.forEach(plant => plant.draw(ctx));

        // Dibujar textos flotantes
        floatingTexts.forEach(ft => ft.draw(ctx));

        // Dibujar partículas
        particles.forEach(p => p.draw(ctx));
        // --- [FIN_ZONA_DRAW_ENTIDADES] ---

        drawLawnmowers();

        // --- [INICIO_ZONA_DRAW_FANTASMA_1.2] ---
        // --- [FIN_ZONA_DRAW_FANTASMA_1.2] ---

        drawUI();

        // --- [INICIO_ZONA_DRAW_COOLDOWN_3.1] ---
        // --- [FIN_ZONA_DRAW_COOLDOWN_3.1] ---

        // --- [INICIO_ZONA_DRAW_PROGRESO_3.3] ---
        // --- [FIN_ZONA_DRAW_PROGRESO_3.3] ---

        // --- [INICIO_ZONA_DRAW_DEBUG_3.2] ---
        // --- [FIN_ZONA_DRAW_DEBUG_3.2] ---

        requestAnimationFrame(gameLoop);
    }

    function drawGrid() {
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        for (let i = 0; i <= COLS; i++) {
            const x = GRID_START_X + (i * CELL_WIDTH);
            ctx.moveTo(x, GRID_START_Y);
            ctx.lineTo(x, GRID_END_Y);
        }
        for (let i = 0; i <= ROWS; i++) {
            const y = GRID_START_Y + (i * CELL_HEIGHT);
            ctx.moveTo(GRID_START_X, y);
            ctx.lineTo(GRID_END_X, y);
        }
        ctx.stroke();
    }

    function drawUI() {
        if (images.barraSemillas) ctx.drawImage(images.barraSemillas, 10, 10);

        const sunCenterX = (sunRange.min + sunRange.max) / 2;
        if (images.sol) {
            const solX = sunCenterX - (images.sol.width / 2);
            ctx.drawImage(images.sol, solX, 0);
        }
        
        ctx.font = '40px Arial';
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        ctx.fillText(sunAmount, sunCenterX, 195);

        const shovelCenterX = (shovelRange.min + shovelRange.max) / 2;
        if (images.pala) {
            const palaX = shovelCenterX - (images.pala.width / 2);
            ctx.drawImage(images.pala, palaX, 0);
        }

        let currentSeedX = seedRange.min;
        
        seeds.forEach(seed => {
            const envolturaImg = images.envoltura;
            const plantaImg = images[seed.imageKey];
            
            if (envolturaImg && plantaImg) {
                const seedWidth = envolturaImg.width; 
                ctx.drawImage(envolturaImg, currentSeedX, 20);
                
                const plantaX = currentSeedX + (seedWidth / 2) - (plantaImg.width / 2);
                ctx.drawImage(plantaImg, plantaX, 0);
                
                ctx.font = '25px Arial';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                const textX = currentSeedX + (seedWidth / 2);
                ctx.fillText(seed.cost, textX, 183);

                currentSeedX += seedWidth;
            }
        });
    }

    function drawLawnmowers() {
        lawnmowers.forEach(mower => {
            if (images.cortacesped) {
                const drawY = GRID_START_Y + (mower.row * CELL_HEIGHT) + (CELL_HEIGHT/2) - (images.cortacesped.height / 2);
                ctx.drawImage(images.cortacesped, mower.x, drawY);
            }
        });
    }

    init();

</script>
</body>
</html>