<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plants vs. Zombies - IA Agents</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        canvas {
            max-width: 100%;
            max-height: 100vh;
            display: block;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="1636" height="1332"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Configuración de la Grid
    const GRID_START_X = 90;
    const GRID_START_Y = 280;
    const GRID_END_X = 1577;
    const GRID_END_Y = 1260;
    const COLS = 9;
    const ROWS = 5;
    const CELL_WIDTH = (GRID_END_X - GRID_START_X) / COLS;
    const CELL_HEIGHT = (GRID_END_Y - GRID_START_Y) / ROWS;
    
    // Variables Globales del Motor
    let frames = 0;
    let isPaused = false;
    let isDebug = false;
    let mouseX = 0;
    let mouseY = 0;
    
    // Arrays de Entidades
    let suns = [];
    let plants = [];
    let zombies = [];
    let peas = [];
    let particles = [];
    let floatingTexts = [];
    const lawnmowers = [];
    
    // Sistema de Hordas
    const LEVEL_CONFIG = { totalZombies: 40, horde1Threshold: 20, horde2Threshold: 38, baseSpawnRate: 350 };
    let zombiesSpawned = 0;

    // Recursos
    const imageSources = {
        background: 'recursos/background.png',
        barraSemillas: 'recursos/barra de semillas.png',
        sol: 'recursos/sol.png', 
        pala: 'recursos/pala.png',
        envoltura: 'recursos/envoltura de semilla.png',
        semillaGirasol: 'recursos/semilla de girasol.png',
        semillaGuisante: 'recursos/semilla de lanza guisantes.png',
        semillaNuez: 'recursos/semilla de nuez.png',
        cortacesped: 'recursos/cortacesped.png'
    };

    // Frames de animación del sol (carga dinámica)
    const sunFrames = [];
    const SUN_TOTAL_FRAMES = 192;
    let sunFramesLoaded = 0;

    const images = {};
    let imagesLoaded = 0;
    const totalImages = Object.keys(imageSources).length;

    // Datos de Semillas
    const seeds = [
        { name: 'girasol', imageKey: 'semillaGirasol', cost: 50, cooldown: 450, timer: 0 },
        { name: 'guisante', imageKey: 'semillaGuisante', cost: 100, cooldown: 450, timer: 0 },
        { name: 'nuez', imageKey: 'semillaNuez', cost: 50, cooldown: 1800, timer: 0 }
    ];

    // Estado del juego UI
    let sunAmount = 50; 
    const sunRange = { min: 10, max: 200 };
    const seedRange = { min: 200, max: 1110 };
    const shovelRange = { min: 1110, max: 1237 };
    
    let selectedSeed = null;
    let isShovelActive = false;
    let gridState = Array.from({ length: COLS }, () => Array(ROWS).fill(null));

    // ==========================================
    // 1. CLASES DE ENTIDADES (Agentes inyectan aquí)
    // ==========================================
    
    // --- [INICIO_ZONA_CLASE_SUN_1.1] ---
    class Sun {
        constructor(x, y, isFalling = true) {
            this.x = x;
            this.y = y;
            this.isFalling = isFalling;
            this.finalY = isFalling ? y + Math.random() * 300 + 200 : y;
            this.fallSpeed = 1.5;
            this.isCollecting = false;
            this.targetX = 105;
            this.targetY = 100;
            this.frame = Math.floor(Math.random() * SUN_TOTAL_FRAMES);
            this.animSpeed = 2;
            this.width = 0;
            this.height = 0;
            this.markedForDeletion = false;
        }

        update() {
            // Animación
            if (frames % this.animSpeed === 0) {
                this.frame = (this.frame + 1) % SUN_TOTAL_FRAMES;
            }

            if (this.isCollecting) {
                // Lerp hacia la UI
                this.x += (this.targetX - this.x) * 0.15;
                this.y += (this.targetY - this.y) * 0.15;

                // Llegó al destino
                if (Math.abs(this.x - this.targetX) < 5 && Math.abs(this.y - this.targetY) < 5) {
                    sunAmount += 25;
                    
                    // FloatingText dorado
                    floatingTexts.push(new FloatingText('+25', this.targetX, this.targetY, '#FFD700'));
                    
                    // Partículas doradas
                    for (let i = 0; i < 8; i++) {
                        particles.push(new Particle(this.targetX, this.targetY, '#FFD700', 'spark'));
                        particles.push(new Particle(this.targetX, this.targetY, '#FFFF00', 'circle'));
                    }
                    
                    this.markedForDeletion = true;
                }
            } else if (this.isFalling) {
                // Caída
                if (this.y < this.finalY) {
                    this.y += this.fallSpeed;
                } else {
                    this.y = this.finalY;
                    this.isFalling = false;
                }
            }
        }

        draw() {
            if (sunFrames[this.frame]) {
                const img = sunFrames[this.frame];
                this.width = img.naturalWidth * 0.5;
                this.height = img.naturalHeight * 0.5;
                const drawX = this.x - this.width / 2;
                const drawY = this.y - this.height / 2;
                ctx.drawImage(img, drawX, drawY, this.width, this.height);
            }
        }

        isClicked(mx, my) {
            const halfW = this.width / 2;
            const halfH = this.height / 2;
            return mx >= this.x - halfW && mx <= this.x + halfW &&
                   my >= this.y - halfH && my <= this.y + halfH;
        }
    }

    class FloatingText {
        constructor(text, x, y, color = '#FFD700') {
            this.text = text;
            this.x = x;
            this.y = y;
            this.color = color;
            this.alpha = 1;
            this.velocityY = -2;
            this.markedForDeletion = false;
        }

        update() {
            this.y += this.velocityY;
            this.alpha -= 0.02;
            if (this.alpha <= 0) {
                this.markedForDeletion = true;
            }
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.font = 'bold 36px Arial';
            ctx.fillStyle = this.color;
            ctx.textAlign = 'center';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 3;
            ctx.strokeText(this.text, this.x, this.y);
            ctx.fillText(this.text, this.x, this.y);
            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color, type = 'circle') {
            this.x = x;
            this.y = y;
            this.color = color;
            this.type = type;
            this.size = Math.random() * 6 + 3;
            this.velocityX = (Math.random() - 0.5) * 8;
            this.velocityY = (Math.random() - 0.5) * 8 - 2;
            this.gravity = 0.15;
            this.alpha = 1;
            this.markedForDeletion = false;
        }

        update() {
            this.x += this.velocityX;
            this.y += this.velocityY;
            this.velocityY += this.gravity;
            this.alpha -= 0.03;
            if (this.alpha <= 0) {
                this.markedForDeletion = true;
            }
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.fillStyle = this.color;
            if (this.type === 'spark') {
                ctx.beginPath();
                ctx.moveTo(this.x, this.y - this.size);
                ctx.lineTo(this.x + this.size * 0.3, this.y);
                ctx.lineTo(this.x, this.y + this.size);
                ctx.lineTo(this.x - this.size * 0.3, this.y);
                ctx.closePath();
                ctx.fill();
            } else {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }
    }

    function spawnSun(x, y, isFalling = true) {
        suns.push(new Sun(x, y, isFalling));
    }

    function loadSunFrames() {
        for (let i = 0; i < SUN_TOTAL_FRAMES; i++) {
            const img = new Image();
            const frameNum = String(i).padStart(3, '0');
            img.src = `recursos/sol/sol${frameNum}.png`;
            img.onload = () => sunFramesLoaded++;
            sunFrames.push(img);
        }
    }
    // --- [FIN_ZONA_CLASE_SUN_1.1] ---

    // --- [INICIO_ZONA_CLASE_PEA_2.2] ---
    // --- [FIN_ZONA_CLASE_PEA_2.2] ---

    // --- [INICIO_ZONA_CLASE_ZOMBIE_2.1] ---
    // --- [FIN_ZONA_CLASE_ZOMBIE_2.1] ---

    // --- [INICIO_ZONA_CLASE_PLANT_1.3] ---
    // --- [FIN_ZONA_CLASE_PLANT_1.3] ---

    // ==========================================
    // 2. INPUTS Y EVENTOS
    // ==========================================
    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
        mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
    });

    canvas.addEventListener('mousedown', (e) => {
        if (isPaused) return;

        // --- [INICIO_ZONA_CLICK_SOLES_1.1] ---
        for (const sun of suns) {
            if (!sun.isCollecting && sun.isClicked(mouseX, mouseY)) {
                sun.isCollecting = true;
                new Audio('recursos/sonidos/Recoger sol 1.wav').play();
                break;
            }
        }
        // --- [FIN_ZONA_CLICK_SOLES_1.1] ---

        // --- [INICIO_ZONA_CLICK_PALA_3.1] ---
        // --- [FIN_ZONA_CLICK_PALA_3.1] ---

        // --- [INICIO_ZONA_CLICK_PLANTAR_1.3] ---
        // --- [FIN_ZONA_CLICK_PLANTAR_1.3] ---

        // --- [INICIO_ZONA_CLICK_SEMILLAS_1.2] ---
        // --- [FIN_ZONA_CLICK_SEMILLAS_1.2] ---
    });

    window.addEventListener('keydown', (e) => {
        // --- [INICIO_ZONA_TECLAS_DEBUG_3.2] ---
        // --- [FIN_ZONA_TECLAS_DEBUG_3.2] ---
    });

    // ==========================================
    // 3. INICIALIZACIÓN
    // ==========================================
    function init() {
        for (let i = 0; i < ROWS; i++) {
            lawnmowers.push({
                x: -70,
                y: GRID_START_Y + (i * CELL_HEIGHT) + (CELL_HEIGHT / 2) - 30,
                row: i,
                active: false
            });
        }
        
        loadImages();
    }

    function loadImages() {
        loadSunFrames();
        for (let key in imageSources) {
            const img = new Image();
            img.src = imageSources[key];
            img.onload = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    console.log('Todas las imágenes cargadas. Iniciando juego.');
                    initGame();
                }
            };
            img.onerror = (e) => console.error('Error cargando imagen:', key, e);
            images[key] = img;
        }
    }

    function initGame() {
        // === [TRIGGER_TAREA_1.1] ===
        spawnSun(200, 300, false);
        spawnSun(400, 300, false);
        // === [FIN_TRIGGER_TAREA_1.1] ===

        // === [TRIGGER_TAREA_1.3] ===
        // === [FIN_TRIGGER_TAREA_1.3] ===

        // === [TRIGGER_TAREA_2.1] ===
        // === [FIN_TRIGGER_TAREA_2.1] ===

        // === [TRIGGER_TAREA_2.2] ===
        // === [FIN_TRIGGER_TAREA_2.2] ===

        // === [TRIGGER_TAREA_3.2] ===
        // === [FIN_TRIGGER_TAREA_3.2] ===

        // === [TRIGGER_TAREA_4.1] ===
        // === [FIN_TRIGGER_TAREA_4.1] ===

        requestAnimationFrame(gameLoop);
    }

    // ==========================================
    // 4. LÓGICA PRINCIPAL (UPDATE)
    // ==========================================
    function checkCollisions() {
        // --- [INICIO_ZONA_COLISIONES_2.3] ---
        // --- [FIN_ZONA_COLISIONES_2.3] ---
    }

    function updateGame() {
        // --- [INICIO_ZONA_UPDATE_ENTIDADES] ---
        // Update suns
        suns.forEach(sun => sun.update());
        suns = suns.filter(sun => !sun.markedForDeletion);

        // Update floating texts
        floatingTexts.forEach(ft => ft.update());
        floatingTexts = floatingTexts.filter(ft => !ft.markedForDeletion);

        // Update particles
        particles.forEach(p => p.update());
        particles = particles.filter(p => !p.markedForDeletion);
        // --- [FIN_ZONA_UPDATE_ENTIDADES] ---

        // === [TRIGGER_TAREA_3.3] ===
        // === [FIN_TRIGGER_TAREA_3.3] ===

        // --- [INICIO_ZONA_SPAWN_NORMAL_2.1] ---
        // --- [FIN_ZONA_SPAWN_NORMAL_2.1] ---

        // --- [INICIO_ZONA_SPAWN_HORDAS_4.2] ---
        // --- [FIN_ZONA_SPAWN_HORDAS_4.2] ---

        checkCollisions();
        frames++;
    }

    // ==========================================
    // 5. RENDERIZADO PRINCIPAL (DRAW)
    // ==========================================
    function gameLoop() {
        if (!isPaused) updateGame();
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (images.background) ctx.drawImage(images.background, 0, 0);

        drawGrid();

        // --- [INICIO_ZONA_DRAW_ENTIDADES] ---
        // Draw suns
        suns.forEach(sun => sun.draw());

        // Draw particles
        particles.forEach(p => p.draw());

        // Draw floating texts
        floatingTexts.forEach(ft => ft.draw());
        // --- [FIN_ZONA_DRAW_ENTIDADES] ---

        drawLawnmowers();

        // --- [INICIO_ZONA_DRAW_FANTASMA_1.2] ---
        // --- [FIN_ZONA_DRAW_FANTASMA_1.2] ---

        drawUI();

        // --- [INICIO_ZONA_DRAW_COOLDOWN_3.1] ---
        // --- [FIN_ZONA_DRAW_COOLDOWN_3.1] ---

        // --- [INICIO_ZONA_DRAW_PROGRESO_3.3] ---
        // --- [FIN_ZONA_DRAW_PROGRESO_3.3] ---

        // --- [INICIO_ZONA_DRAW_DEBUG_3.2] ---
        // --- [FIN_ZONA_DRAW_DEBUG_3.2] ---

        requestAnimationFrame(gameLoop);
    }

    function drawGrid() {
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        for (let i = 0; i <= COLS; i++) {
            const x = GRID_START_X + (i * CELL_WIDTH);
            ctx.moveTo(x, GRID_START_Y);
            ctx.lineTo(x, GRID_END_Y);
        }
        for (let i = 0; i <= ROWS; i++) {
            const y = GRID_START_Y + (i * CELL_HEIGHT);
            ctx.moveTo(GRID_START_X, y);
            ctx.lineTo(GRID_END_X, y);
        }
        ctx.stroke();
    }

    function drawUI() {
        if (images.barraSemillas) ctx.drawImage(images.barraSemillas, 10, 10);

        const sunCenterX = (sunRange.min + sunRange.max) / 2;
        if (images.sol) {
            const solX = sunCenterX - (images.sol.width / 2);
            ctx.drawImage(images.sol, solX, 0);
        }
        
        ctx.font = '40px Arial';
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        ctx.fillText(sunAmount, sunCenterX, 195);

        const shovelCenterX = (shovelRange.min + shovelRange.max) / 2;
        if (images.pala) {
            const palaX = shovelCenterX - (images.pala.width / 2);
            ctx.drawImage(images.pala, palaX, 0);
        }

        let currentSeedX = seedRange.min;
        
        seeds.forEach(seed => {
            const envolturaImg = images.envoltura;
            const plantaImg = images[seed.imageKey];
            
            if (envolturaImg && plantaImg) {
                const seedWidth = envolturaImg.width; 
                ctx.drawImage(envolturaImg, currentSeedX, 20);
                
                const plantaX = currentSeedX + (seedWidth / 2) - (plantaImg.width / 2);
                ctx.drawImage(plantaImg, plantaX, 0);
                
                ctx.font = '25px Arial';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                const textX = currentSeedX + (seedWidth / 2);
                ctx.fillText(seed.cost, textX, 183);

                currentSeedX += seedWidth;
            }
        });
    }

    function drawLawnmowers() {
        lawnmowers.forEach(mower => {
            if (images.cortacesped) {
                const drawY = GRID_START_Y + (mower.row * CELL_HEIGHT) + (CELL_HEIGHT/2) - (images.cortacesped.height / 2);
                ctx.drawImage(images.cortacesped, mower.x, drawY);
            }
        });
    }

    init();

</script>
</body>
</html>